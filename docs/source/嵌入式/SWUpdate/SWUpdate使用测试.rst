SWUpdate使用测试
===========================================================

假设当前已搞定了AB系统分区、SWUpdate基础移植等工作。
需实际测试 SWUpdate 的功能。

步骤1)首先测试最基础的 SWUpdate 升级功能
-----------------------------------------------------------

此时，SWUpdate的编译选项都未开启，使用最基础的配置，编写示例：

对编好的 rootfs 进行 gzip 压缩，得到 root.ext4.gzip

.. note:: 不压缩的话体积太大，不便于传输和烧录

编写描述文件 sw-description：

::
    
    software = {
        version = "0.0.1";

        rootfs = {
            rootfs-1: {
                images: ({
                    filename = "root.ext4.gz";
                    compressed = "zlib";
                    device = "/dev/mmcblk0p5";
                });
            }
            rootfs-2: {
                images: ({
                    filename = "root.ext4.gz";
                    compressed = "zlib";
                    device = "/dev/mmcblk0p6";
                })
            }
        }
    }

.. note:: 使用了压缩，记得一定要添加 ``compressed = "zlib";``

编写简单烧录脚本 makeswu.sh：

::

    IMG_FILES="sw-description root.ext4.gz"

    for f in ${IMG_FILES} ;
    do
        echo ${f}
    done | cpio -ovL -H crc > myfirst.swu

    echo '输出swu信息'
    cat myfirst.swu | cpio -it`


将其统一放入一个测试文件夹中，目录如下：

::

    testswu$ ls
    makeswu.sh  myfirst.swu  root.ext4.gz  sw-description

接下来就将 myfirst.swu 传入机器内，在机器内 shell 手动执行升级 rootfs 分区的操作：

::

    root@OpenWrt:~# swupdate -i myfirst.swu -e rootfs,rootfs-2
    Swupdate v2019.04.0

    Licensed under GPLv2. See source distribution for detailed copyright notices.

    Registered handlers:
        dummy
        uboot
        bootloader
        raw
        rawfile
        shellscript
        preinstall
        postinstall
    software set: rootfs mode: rootfs-2
    Software updated successfully
    Please reboot the device to start the new software
    [INFO ] : SWUPDATE successful !

检查目录可发现，当前rootfs已被重新烧录刷新。

步骤2)再测试的 SWUpdate 高级功能
-----------------------------------------------------------




sw-description键值及描述
-----------------------------------------------------------

+----------------------+--------------+---------+----------------------------------------------------------------+
|          键          |     类型     |  值类型 |                              描述                              |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              | images  |                                                                |
| filename             | string       | files   | 在cpio存档中找到的文件名                                       |
|                      |              | scripts |                                                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
| volume               | string       | images  | 仅限type=“ubivol”时使用。必须安装映像的UBI卷。                 |
+----------------------+--------------+---------+----------------------------------------------------------------+
| ubipartition         | string       | images  | 仅限type=“ubivol”时使用。要创建或调整新大小的卷                |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              |         | /dev 中的设备节点或其符号链接。                                |
|                      |              |         | 可以指定为绝对路径或/dev文件夹中的名称。                       |
|                      |              | images  | 例如，如果/dev/mtd-dtb是/dev/mtd3的链接 “mtd3”、               |
| device               | string       | files   | “mtd-dtb”、“/dev/mtd3” 和 “/dev /mtd-dtb”是有效名称。          |
|                      |              |         | 用法取决于处理程序。                                           |
|                      |              |         | 对于文件，它指示“文件系统”必须安装在哪个设备上。               |
|                      |              |         | 如果未指定，将使用当前的 rootfs。                              |
+----------------------+--------------+---------+----------------------------------------------------------------+
| filesystem           | string       | files   | 仅限设置了“device”属性时使用。指示必须安装文件的文件系统类型。 |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              |         | 对于文件: 指示必须安装文件的路径(绝对路径)。                   |
| path                 | string       | files   | 如果设置了“设备”和“文件系统”，SWUpdate将在挂载                 |
|                      |              |         | “文件系统”类型的“设备”后安装文件。                             |
|                      |              |         | (路径总是相对于挂载点）。                                      |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              |         | 控制当文件从归档中解压缩时是否保留以下属性                     |
| preserve-attributes  | bool         | files   | （假设目标文件系统支持它们）：                                 |
|                      |              |         | 时间戳、uid/gid(数字)、perms、文件属性、扩展属性               |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              | images  | 处理程序的字符串标识符，它由处理程序在注册自身时设置。         |
| type                 | string       | files   | 示例：“ubivol”、“raw”、“rawfile”、                             |
|                      |              | scripts |                                                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
| compressed           | string       | images  | 指示文件已压缩，安装前必须解压。                               |
|                      |              | files   | 该值表示压缩类型。当前支持的值为“zlib”和“zstd”。               |
+----------------------+--------------+---------+----------------------------------------------------------------+
| compressed           | bool         | images  | 已弃用。使用字符串形式。true相当于compressed=“zlib”。          |
|                      | (deprecated) | files   |                                                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
| installed-directly   | bool         | images  | 指示镜像已流式传输到目标，且没有任何临时副本。                 |
|                      |              |         | 并非所有处理程序都支持流式传输。                               |
+----------------------+--------------+---------+----------------------------------------------------------------+
| name                 | string       | bootenv | 要设置的引导加载程序变量的名称。                               |
+----------------------+--------------+---------+----------------------------------------------------------------+
| value                | string       | bootenv | 分配给引导加载程序变量的值                                     |
+----------------------+--------------+---------+----------------------------------------------------------------+
| name                 | string       | images  | 标识sw-component的名称，它可以是任何字符串，                   |
|                      |              | files   | 并与sw-versions中的条目进行比较                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
| version              | string       | images  | sw-component的版本，它可以是任何字符串，                       |
|                      |              | files   | 并与sw-versions中的条目进行比较                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
| description          | string       |         | swupdate存档的用户友好描述（任何字符串）                       |
+----------------------+--------------+---------+----------------------------------------------------------------+
| reboot               | bool         |         | 允许禁用重新启动，针对当前正在运行的更新                       |
+----------------------+--------------+---------+----------------------------------------------------------------+
| install-if-different | bool         | images  | 如果设置该标志，name和version将                                |
|                      |              | files   | 与sw-versions中的条目进行比较                                  |
+----------------------+--------------+---------+----------------------------------------------------------------+
| install-if-higher    | bool         | images  | 如果设置该标志，name和version将                                |
|                      |              | files   | 与sw-versions中的条目进行比较                                  |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              | images  |                                                                |
| encrypted            | bool         | files   | 如果设置该标志，则文件已加密，并且必须在安装前解密。           |
|                      |              | scripts |                                                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              | images  | 在工件加密的情况下，如果未设置“加密”，则该IVT没有价值。        |
| ivt                  | string       | files   | 每个工件可以有自己的IVT，以避免攻击者可以猜测的关键。          |
|                      |              | scripts | 这是一个32个字符的ASCII字符串                                  |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              | images  |                                                                |
| data                 | string       | files   | 用于传递任意数据给处理程序。                                   |
|                      |              | scripts |                                                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
|                      |              | images  | 图像、文件或脚本的sha256哈希值。                               |
| sha256               | string       | files   | 用于验证签名图像。                                             |
|                      |              | scripts |                                                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
| embedded-script      | string       |         | 嵌入在sw-description文件中的Lua代码。                          |
+----------------------+--------------+---------+----------------------------------------------------------------+
| offset               | string       | images  | （可选）目标偏移量                                             |
+----------------------+--------------+---------+----------------------------------------------------------------+
| hook                 | string       | images  | 解析条目时要调用的函数名（Lua）。                              |
|                      |              | files   |                                                                |
+----------------------+--------------+---------+----------------------------------------------------------------+
| mtdname              | string       | images  | 要更新的MTD的名称。仅由flash handler使用，                     |
|                      |              |         | 用于识别要更新的mtd，而不是指定设备节点。                      |
+----------------------+--------------+---------+----------------------------------------------------------------+

功能与menuconfig配置项的对应：

特别说明：

* sha256 ~ 依赖开启 SWUPDATE_CONFIG_HASH_VERIFY。
* type ~ 可用于特异化配置，如 TinaOS 中 type = "awboot0" 配合处理程序升级 boot0，
   type = "awboot0" 升级 uboot。



swupdate二进制参数及描述
-----------------------------------------------------------

+--------------------------+--------+------------------------------------------------------------+
|           范围           |  类型  |                            描述                            |
+--------------------------+--------+------------------------------------------------------------+
| -f <file>                | string | SWUpdate要使用的配置文件。                                 |
|                          |        | 详细信息请参见examples/configuration/swupdate.cfg 源代码。 |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | 仅限设置CONFIG_UBIATTACH时可用。                           |
| -b <string>              | string | 当SWUpdate搜索UBI卷时，它允许将MTD 列入黑名单。            |
|                          |        | 示例：MTD0-1中的U-Boot and environment： swupdate -b "0 1" |
+--------------------------+--------+------------------------------------------------------------+
| -B <loader>              | string | 覆盖默认的bootloader接口，使用loader代替。                 |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | sel的格式为<软件>,<模式>。                                 |
|                          |        | 它允许人们在sw-description 文件中找到规则的子集。          |
| -e <sel>                 | string | 有了它，就可以允许多个规则。                               |
|                          |        | 一种常见的用法是双副本方法。                               |
|                          |        | 示例：-e “stable, copy1” ==> 安装在 copy1 上               |
|                          |        | -e “stable, copy2” ==> 安装在 copy2 上                     |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | sel格式为<软件>,<模式>。                                   |
| --excluded <sel>         | string | 它设置不能用于更新的选择黑名单。允许多个排除。             |
|                          |        | 不仅可以使用-e激活选择，还可以通过IPC 激活选择。           |
+--------------------------+--------+------------------------------------------------------------+
| -h                       | -      | 帮助                                                       |
+--------------------------+--------+------------------------------------------------------------+
| -k <file>                | string | 仅限设置CONFIG_SIGNED时可用。                              |
|                          |        | 带有公钥的文件名。                                         |
+--------------------------+--------+------------------------------------------------------------+
| -K <file>                | string | 仅限设置CONFIG_ENCRYPTED_IMAGES时可用。                    |
|                          |        | 带有用于解密的对称密钥的文件名。                           |
+--------------------------+--------+------------------------------------------------------------+
| -cert-purpose <purpose>  | string | 仅限设置CONFIG_SIGNED_IMAGES时可用。                       |
|                          |        | 设置预期的证书用途。                                       |
+--------------------------+--------+------------------------------------------------------------+
| -forced-signer-name <cn> | string | 仅限设置CONFIG_SIGNED_IMAGES时可用。。                     |
|                          |        | 设置签名者证书的预期公用名。                               |
+--------------------------+--------+------------------------------------------------------------+
| -ca-path <file>          | string | 仅限设置CONFIG_SIGNED_IMAGES时可用。                       |
|                          |        | 证书颁发机构（PEM）的路径。                                |
+--------------------------+--------+------------------------------------------------------------+
| -get-root                | -      | 检测并打印根设备并退出。                                   |
+--------------------------+--------+------------------------------------------------------------+
| -l <level>               | int    | 设置日志级别。                                             |
+--------------------------+--------+------------------------------------------------------------+
| -L                       | -      | 将LOG输出发送到syslog（local）。                           |
+--------------------------+--------+------------------------------------------------------------+
| -i <file>                | string | 使用本地.swu文件运行SWUpdate。                             |
+--------------------------+--------+------------------------------------------------------------+
| -n                       | -      | 在试运行模式下运行SWUpdate。                               |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | 所需的最低软件版本。                                       |
| -N <version>             | string | 这将与新软件的版本进行检查并禁止降级。                     |
|                          |        | 版本由4个数字组成（major.minor.rev.build，每个             |
|                          |        | 字段的范围为0..65535），或者它是一个语义版本。             |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | 所需的最高软件版本。                                       |
| -max-version <version>   | string | 这将通过新软件的版本进行检查。                             |
|                          |        | 版本由4个数字组成（major.minor.rev.build，每个             |
|                          |        | 字段的范围为0..65535），或者它是一个语义版本。             |
+--------------------------+--------+------------------------------------------------------------+
| -R <version>             | string | 当前安装的软件版本。                                       |
|                          |        | 这将与新软件的版本进行检查并禁止重新安装。                 |
+--------------------------+--------+------------------------------------------------------------+
| -o <file>                | string | 将SWU流保存到文件中。                                      |
+--------------------------+--------+------------------------------------------------------------+
| -v                       | -      | 激活详细输出。                                             |
+--------------------------+--------+------------------------------------------------------------+
| -M                       | -      | 禁用设置bootloader事务标记。                               |
+--------------------------+--------+------------------------------------------------------------+
| -m                       | -      | 禁用在bootloader中设置更新状态。                           |
+--------------------------+--------+------------------------------------------------------------+
| -w <parms>               | string | 仅限设置CONFIG_WEBSERVER时可用。                           |
|                          |        | 启动内部网络服务器并向其传递命令行字符串。                 |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | 仅限设置CONFIG_DOWNLOAD时可用。                            |
| -d <parms>               | string | 启动内部下载程序客户端并向其传递命令行字符串。             |
|                          |        | 另见下载程序的内部命令行参数。                             |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | 仅限设置CONFIG_SURICATTA时可用。                           |
| -u <parms>               | string | 启动内部suricatta客户端守护进程并向其传递                  |
|                          |        | 命令行字符串。另见suricatta的内部命令行参数。              |
+--------------------------+--------+------------------------------------------------------------+
| -H <board:rev>           | string | 仅限设置CONFIG_HW_COMPATIBILITY时可用。                    |
|                          |        | 设置板子名称和硬件版本。                                   |
+--------------------------+--------+------------------------------------------------------------+
|                          |        | 检查*.swu文件。                                            |
| -c                       | -      | 用于确保sw-description中所引用的文件存在。                 |
|                          |        | 用法：swupdate -c -i <file>                                |
+--------------------------+--------+------------------------------------------------------------+
| -P <cmd>                 | string | 执行"预更新"命令。                                         |
+--------------------------+--------+------------------------------------------------------------+
| -p <cmd>                 | string | 执行"更新后"命令。                                         |
+--------------------------+--------+------------------------------------------------------------+